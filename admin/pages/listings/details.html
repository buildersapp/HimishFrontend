<!DOCTYPE html>
<html lang="en">
<?php include('includes/head.php') ?>
<link rel="stylesheet" href="assets/plugins/datatable/css/dataTables.bootstrap5.min.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css" />

<body>
    <!-- wrapper start  -->
    <div class="wrapper relative">
        <?php include('includes/sidebar.php') ?>

        <!-- header start  -->
        <?php include('includes/nav-header.php') ?>
        <!-- header end  -->

        <!-- content area start  -->
        <div class="listings-details-page-sec">
            <main class="user-main">
                <div class="user-row">

                    <!-- avatar card  -->
                    <div class="w-24">
                        <div class="user-left user-left2 w-100">

                            <div class="avatar-img">
                                <!-- <img src="assets/img/user/avatar.png" class="img-fluid" alt="Avatar" /> -->
                                <img src="<?php echo ($final['user']['image']) ?  MEDIA_BASE_URL.$final['user']['image'] : 'assets/img/user/avatar.png';?>"
                                    class="img-fluid rounded-pz" alt="Avatar"
                                    onerror="this.onerror=null; this.src='assets/img/user/avatar.png';" />

                            </div>
                            <div class="avatar-content">
                                <h1>
                                    <?=$final['user']['name']?>
                                </h1>
                                <p>User</p>
                            </div>
                            <div class="avatar-icon-box-wraper">
                                <div class="avatar-icon-box">
                                    <div class="avatat-icon-img">
                                        <img src="assets/img/user/camera.png" alt="" />
                                    </div>
                                    <div class="avatat-icon-content">
                                        <h2>
                                            <?= $final['user']['total_posts'];?>
                                        </h2>
                                        <p>Total Posts</p>
                                    </div>
                                </div>
                                <div class="avatar-icon-box">
                                    <div class="avatat-icon-img">
                                        <h3>Ad</h3>
                                    </div>
                                    <div class="avatat-icon-content">
                                        <h2>
                                            <?= $final['user']['total_ads'];?>
                                        </h2>
                                        <p>Total Ads</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="pt-3 cmn-img-bottom">
                            <img src="<?php echo (count($final['post_images']) > 0) ?  MEDIA_BASE_URL.$final['post_images'][0]['image'] : 'assets/img/user/poster.png';?>"
                                alt="poster" class="img-fluid w-100">
                        </div>
                    </div>






                    <div class="user-right">
                        <!-- Tab header -->

                         <ul class="tablist">
                                <li class="active-tablist" id="post-details-tb" data-tab="post-details">
                                    Listing Details
                                </li>
                                <li data-tab="locations" id="locationsTb">Listing Locations</li>
                            </ul>
                       

                        <!-- Tab content (initially, only one should be visible) -->
                        <div class="ps-lg-4 tab-content" id="post-details">


                            <!-- Banner Image: start  -->
                            <div class="bannerImage mb-4 mt-3 ">
                                <p class="ps-0">Listing Image:</p>
                                <div class="bannerImageItem text-center d-flex justify-content-start flex-wrap gap-3">
                                    <?php  foreach($final['post_images'] as $k => $v) { ?>
                                    <div class="col-box-itm one">
                                        <div class="img-upload">
                                            <input type="file" id="imgUpload" class="d-none" />
                                            <label for="imgUpload"><span><img
                                                        src="<?php echo MEDIA_BASE_URL.$v['image'];?>" class="img-fluid"
                                                        alt="Avatar" />
                                                </span>
                                            </label>
                                            <i class="fa fa-trash text-danger delete-img-btn"
                                                data-id="<?= $v['id'] ?>"></i>
                                        </div>
                                    </div>
                                    <?php } ?>

                                    <div class=" col-box-itm two">
                                        <div class="img-upload">
                                            <input type="file" name="image" accept="image/*" id="imageShow"
                                                class="d-none" onchange="previewImage(event)" />
                                            <label for="imageShow">
                                                <span>
                                                    <img id="previewImg" src="assets/img/user/plus.png"
                                                        alt="Upload Image" class="img-fluid" />
                                                </span>
                                                <span id="textHd">Upload Image</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <form class="user-form ps-0 pb-0" id="myPostForm" method="post">
                                <div class="row g-2 mb-2"" id="user-form-row">
                                    <div class="col-md-4">
                                        <div>
                                            <label for="name">Title</label>
                                            <input type="text" name="title" id="title"
                                                value="<?php echo $final['title']; ?>" placeholder="Looking for"
                                                class="form-control" />
                                                <input type="hidden" name="type" id="type" value="<?php echo $final['type']; ?>" />
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div>
                                            <label for="email">Visible</label>
                                            <div class="StatusActive">
                                                <select class="form-select" name="status"
                                                    aria-label="Default select example">
                                                    <option value="1" <?php echo ($final['status']==1)
                                                        ? 'selected  class="StatusActiveItem"' : '' ;?>>Visible</option>
                                                    <option value="0" <?php echo ($final['status']==0)
                                                        ? 'selected class="StatusActiveItem"' : '' ;?>>Non-Visible</option>
                                                    <option value="2" <?php echo ($final['status']==2)
                                                        ? 'selected class="StatusActiveItem"' : '' ;?>>Draft</option>
                                                </select>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div>
                                            <label for="title">Service / Product:</label>
                                            <select id="post_type" class="form-select" name="post_type">
                                                <option value="" <?=($defaultType=='' ) ? 'selected' : '' ?>>Select
                                                    Post Type</option>
                                                <option value="1" <?=($defaultType=='1' ) ? 'selected' : '' ?>
                                                    >Services</option>
                                                <option value="2" <?=($defaultType=='2' ) ? 'selected' : '' ?>
                                                    >Products</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-md-10 mt-2">
                                        <div>
                                            <label for="title">Select Category</label>
                                            <a href="add-update-master-category.php?post_id=<?= base64_encode($final['id']) ?>&page=listing"
                                                class="float-right" target="_blank">Click here if you can't find
                                                your category</a>
                                            <select id="post_category_master" class="form-select"
                                                name="post_category_master">
                                                <option value="">Select Category</option>
                                                <?php foreach ($masterCatSub as $kt => $vt) { ?>
                                                <option value="<?= $vt['id'] ?>"
                                                    data-tab_label_option_posts="<?= htmlspecialchars($vt['tabLabelOptionPosts'], ENT_QUOTES, 'UTF-8'); ?>"
                                                    data-keywords="<?= htmlspecialchars($vt['keywords1'], ENT_QUOTES, 'UTF-8'); ?>"
                                                    <?=($defaultCategory==$vt['id']) ? 'selected' : '' ; ?>
                                                    >
                                                    <small class="grey">
                                                        <?= implode(' > ', array_slice($vt['names'], 0, -1)) ?>
                                                        <?php if (!empty($vt['names'])): ?>
                                                        <p class="bold"> >
                                                            <?= end($vt['names']); ?>
                                                        </p>
                                                        <?php endif; ?>
                                                    </small>
                                                </option>
                                                <?php } ?>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="title">Tab Label</label>
                                        <select id="category" class="form-select" name="category">
                                            <?php 
                                                foreach ($defaultTabLabels as $kt => $vt) { 
                                            ?>
                                            <option value="<?= htmlspecialchars($vt, ENT_QUOTES, 'UTF-8'); ?>"
                                                <?=($final['category']==htmlspecialchars($vt,
                                                ENT_QUOTES, 'UTF-8' )) ? 'selected' : '' ; ?>>
                                                <?= htmlspecialchars($vt, ENT_QUOTES, 'UTF-8'); ?>
                                            </option>
                                            <?php } ?>
                                        </select>
                                    </div>


                                    <!-- <input type="hidden" name="service" id="service" value="<?= $final['service'];?>"> -->
                                    <input type="hidden" name="post_id" value="<?= $final['id'];?>">
                                </div>
                                    <div class="row g-2 mb-2"> <div class="col-md-12">
                                        <label for="number">keywords(Pills)</label>
                                        <input type="text" name="service" id="service" value="<?php echo $final['service']; ?>"
                                            placeholder="Post keywords here..." class="form-control">
                                        
                                    </div>
                                </div>

                                <div class="row g-2 mb-2">
                                    <!-- <div class="col-md-9">
                                        <label for="number">Address</label>
                                        <input type="text" name="address" id="address" oninput="initAutocomplete()"
                                            value="<?php echo $final['address']; ?>"
                                            placeholder="Post address here..." class="form-control">
                                        <input type="hidden" name="latitude" id="latitude"
                                            value="<?php echo $final['latitude']; ?>">
                                        <input type="hidden" name="longitude" id="longitude"
                                            value="<?php echo $final['longitude']; ?>">
                                        <input type="hidden" name="country_code" id="country_code" value="">
                                        <input type="hidden" name="city" id="city">
                                        <input type="hidden" name="state" id="state">
                                    </div> -->
                                    <div class="col-md-3">
                                        <?php 
                                        $datetime = (new DateTime($final['created_at']))->format('Y-m-d\TH:i');
                                            
                                        ?>
                                        <div>
                                            <label for="date">Created Date:</label>
                                            <input type="datetime-local" name="created_at" id="datetime"
                                                value="<?= $datetime;?>" class="form-control">

                                        </div>
                                    </div>

                                    <div class="col-md-3">
                                        <div>
                                            <?php
                                    $expire_timestamp = $final['expire_date'];
                                    $expire_date = 0;
                                    if($expire_timestamp > 0) {
                                        $expire_date = date('Y-m-d\TH:i', $expire_timestamp);
                                    }
                                    
                                    ?>
                                            <label for="date">Expiration Date:</label>
                                            <input type="datetime-local" name="expire_date" id="datetime"
                                                value="<?=$expire_date;?>" class="form-control">


                                        </div>
                                    </div>
                                </div>
                                <div class="row g-2 mb-2">
                                    <div class="col-md-6">
                                        <div>
                                            <label for="Website">Description</label>
                                            <textarea rows="4" cols="4" name="info" placeholder="Post info here..."
                                                class="form-control"><?php echo $final['info']; ?></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div>
                                            <label for="Twitter">Communities:</label>
                                            <div class="tagsInput mt-2 community-container">
                                                <select class="form-select" id="community" multiple="multiple"
                                                    name="community[]" aria-label="Default select example">
                                                    <?php foreach ($community as $kc=>$vcc) {
                                                        $selected = in_array($vcc['name'], $community_array) ? 'selected' : '';
                                                    ?>
                                                    <option value="<?= $vcc['name'];?>" <?=$selected; ?>>
                                                        <?=$vcc['name']; ?>
                                                    </option>
                                                    <?php } ?>
                                                </select>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <?php if (hasPermission('Listings', 'edit')) { ?>
                                    <div class="col-12 mt-4">
                                        <div class="d-flex flex-wrap gap-3">
                                            <button type="button" class="btn btnSave">Save</button>
                                            <button class="btn btnClose">Cancel</button>
                                        </div>
                                    </div>
                                    <?php } ?>


                                </div>
                            </form>
                        </div>

                        <!-- location -->

                         <div id="locations" class="tab-content hidden">
                            <!-- Locations Table -->
                            <div class="table-responsive table-space">
                                <h5>Listing Locations</h5>
                                 <hr />
                                <!-- Add New Loc Row -->
                                <table class="table table-bordered table-striped">
                                    <tr>
                                        <form method="POST">
                                            <td class="col-md-4">
                                                <input type="text" id="address_new2" name="address" class="form-control address-autocomplete" placeholder="Enter address" autocomplete="off" />
                                            </td>
                                            <td class="col-md-2">
                                                <input type="text" id="state_new2" name="state" class="form-control" placeholder="State" />
                                            </td>
                                            <td class="col-md-3">
                                                <input type="text" id="city_new2" name="city" class="form-control" placeholder="City" />
                                            </td>
                                            <td class="col-md-3">
                                                <input type="text" id="country_code_new2" name="country_code" class="form-control" placeholder="Country Code" />
                                            </td>
                                            <td class="text-center">
                                                <input type="hidden" name="type" value="1">
                                                <input type="hidden" id="longitude_new2" name="longitude" class="form-control" placeholder="Longitude" />
                                                <input type="hidden" id="latitude_new2" name="latitude" class="form-control" placeholder="Latitude" />
                                                <?php if (hasPermission('Listings', 'edit')) { ?>
                                                <button type="submit" name="addPostLoc" class="btn btn-success btn-sm">
                                                    <i class="fas fa-plus-circle"></i> Add Location
                                                </button>
                                                <?php } ?>
                                            </td>
                                        </form>
                                    </tr>
                                </table>

                                <hr />
                                <?php if (count($final['post_locations']) > 0): ?>
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                            <tr>
                                                <th>Address</th>
                                                <th>State</th>
                                                <th>City</th>
                                                <th>Latitude</th>
                                                <th>Longitude</th>
                                                <th>Country Code</th>
                                                <th class="text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <?php foreach ($final['post_locations'] as $index => $location): ?>
                                            <tr>
                                                <form method="POST">
                                                    <!-- Address with Autocomplete -->
                                                    <td class="col-md-4">
                                                        <input type="text" id="address_<?= $index ?>" name="address" value="<?= htmlspecialchars($location['address']) ?>" class="form-control address-autocomplete" autocomplete="off" />
                                                    </td>
                                                    <td class="col-md-1">
                                                        <input type="text" id="state_<?= $index ?>" name="state" value="<?= htmlspecialchars($location['state']) ?>" class="form-control" />
                                                    </td>
                                                    <td class="col-md-3">
                                                        <input type="text" id="city_<?= $index ?>" name="city" value="<?= htmlspecialchars($location['city']) ?>" class="form-control" />
                                                    </td>
                                                    <td class="col-md-1">
                                                        <input type="text" id="latitude_<?= $index ?>" name="latitude" value="<?= htmlspecialchars($location['latitude']) ?>" class="form-control" />
                                                    </td>
                                                    <td class="col-md-1">
                                                        <input type="text" id="longitude_<?= $index ?>" name="longitude" value="<?= htmlspecialchars($location['longitude']) ?>" class="form-control" />
                                                    </td>
                                                    <td class="col-md-1">
                                                        <input type="text" id="country_code_<?= $index ?>" name="country_code" value="<?= htmlspecialchars($location['country_code']) ?>" class="form-control" />
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="hidden" name="location_id" value="<?= $location['id']; ?>">
                                                        <?php if (hasPermission('Listings', 'edit')) { ?>
                                                        <button type="submit" class="btn btn-info btn-sm" name="updateLoc">
                                                            <i class="fas fa-save"></i> Update
                                                        </button>
                                                        <?php } ?>
                                                    </td>
                                                </form>
                                            </tr>
                                            <?php endforeach; ?>
                                        </tbody>
                                    </table>
                                <?php else: ?>
                                    <p>No Listing locations available.</p>
                                <?php endif; ?>

                               


                              

                              

                            </div>
<?php if (hasPermission('Listings', 'edit')) { ?>
                            <div class="fixed-center-buttons d-flex flex-wrap gap-3">
                                <button type="button" class="btn btnSave btnSavePost">Save Post Details</button>
                            </div>
                            <?php } ?>
                        </div>



                    </div>
                </div>
            </main>
        </div>
        <!-- content area end -->


    </div>
    <!-- wrapper end  -->
    <script src="assets/plugins/datatable/js/jquery.dataTables.min.js?v=<?= time() ?>"></script>
    <script src="assets/plugins/select2/select2-custom.js?v=<?= time() ?>"></script>
    <?php include('includes/footer-scripts.php') ?>
    <script src="assets/js/postDetails.js?v=<?= time() ?>"></script>
     <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab');      // e.g., ?tab=post-details
            const redirect = urlParams.get('redirect');  // e.g., ?redirect=categories
        
            const defaultTab = redirect || activeTab || 'post-details';

            console.log(defaultTab);
        
            const tabListItems = document.querySelectorAll('.tablist li');
            const tabContents = document.querySelectorAll('.tab-content');
        
            tabListItems.forEach((tab) => {
                tab.classList.remove('active-tablist');
        
                if (tab.dataset.tab === defaultTab) {
                    tab.classList.add('active-tablist'); // activate tab
                }
            });
        
            tabContents.forEach((content) => {
                content.classList.add('hidden');
        
                if (content.id === defaultTab) {
                    content.classList.remove('hidden'); // show related content
                }
            });
        });
    </script> 
    <script>
        function previewImage(event) {
            const fileInput = event.target;
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    const previewImg = document.getElementById('previewImg');
                    previewImg.src = e.target.result; // Set the image source to the file's data URL
                    previewImg.style.height = '140px'; // Set the height to 140px
                    previewImg.style.width = '140px'; // Set the height to 140px
                    previewImg.style.objectFit = 'cover'; // Optional: To maintain aspect ratio
                };

                reader.readAsDataURL(file);
            }
            $('#textHd').html('')
        }

        $(document).ready(function () {

            $('#post_category_master').select2();

            $('#post_category_master').change(function () {
                // Get the selected option
                const selectedOption = $(this).find(':selected');
                const tabLabelOptions = selectedOption.data('tab_label_option_posts');
                const keywords = selectedOption.data('keywords');
                const $tabDropdown = $('#category');

                // Append keywords to the existing value of service
                const existingService = "<?php echo $final['service']; ?>";
                const appendedService = existingService + (keywords ? ', ' + keywords : '');
                $('#service').val(keywords);

                // Clear existing options
                $tabDropdown.html('<option value="">Select an Option</option>');

                // Populate new options if data is available
                if (tabLabelOptions) {
                    const optionsArray = tabLabelOptions.split(','); // Split into individual options
                    $.each(optionsArray, function (index, value) {
                        const trimmedValue = $.trim(value);
                        $tabDropdown.append(`<option value="${trimmedValue}">${trimmedValue}</option>`);
                    });
                }
            });

            // get product / service based on type
            $('#post_type').change(function () {
                var selectedType = $(this).val();

                // Send the new value via AJAX
                $.ajax({
                    url: 'ajax.php?action=get_master_sub_cat__by_type',
                    type: 'POST',
                    data: { type: selectedType },
                    success: function (response) {
                        var categories = JSON.parse(response);

                        $('#post_category_master').empty();
                        $('#category').empty();

                        // Append keywords to the existing value of service
                        const existingService = "<?php echo $final['service']; ?>";
                        $('#service').val(existingService);
                        //$('#service').empty();

                        $('#post_category_master').append('<option value="">Select Category</option>');

                        categories.forEach(function (category) {
                            var option = $('<option></option>')
                                .val(category.id)
                                .data('tab_label_option_posts', category.tabLabelOptionPosts)
                                .data('keywords', category.keywords1);

                            // Create the category names string, ensuring that the last name does not have a trailing '>'
                            var categoryNames = category.names.slice(0, -1).join(' > ') + (category.names.length > 0 ? ' > ' + category.names[category.names.length - 1] : '');

                            option.html('<small class="grey">' + categoryNames + '</small><p class="bold"> > ' + category.names[category.names.length - 1] + '</p>');

                            $('#post_category_master').append(option);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.log('Error: ' + error);
                    }
                });
            });
        });

        function categorizeKeywords() {
            var keyWords = $("#service").val();
            if (!keyWords.trim()) {
                alert("Please enter keywords.");
                return;
            }

            // Split keywords and clear existing rows
            var keywordsArray = keyWords.split(',').map(keyword => keyword.trim());
            var tableBody = $("#keywordsTable tbody");
            tableBody.empty();

            // Populate table with keywords
            keywordsArray.forEach((keyword, index) => {
                var row = `
                        <tr>
                            <td>${keyword}</td>
                            <td>
                                <select class="form-control category-select">
                                    `+ $("#post_category_master").html() + `
                                </select>
                            </td>
                            <td>
                                <button type="button" class="btn btn-success save-btn" data-keyword="${keyword}">Save</button>
                            </td>
                        </tr>`;
                tableBody.append(row);
            });

            //$('.category-select').select2();

            // Show the modal
            $('#categorizeM').modal('show');
        }

        // Event delegation to handle dynamically added save buttons
        $(document).on('click', '.save-btn', function () {
            var keyword = $(this).data('keyword');
            var category = $(this).closest('tr').find('.category-select').val();
            var btn = $(this);
            if (!category) {
                alert("Please select a category for " + keyword);
                return;
            }

            // Send the new value via AJAX
            $.ajax({
                url: 'ajax.php?action=update_post_keywords',
                type: 'POST',
                data: { keyword: keyword, category: category },
                success: function (response) {
                    response = JSON.parse(response);
                    console.log(response);
                    if (response.success) {
                        btn.text('Saved');
                        btn.attr('disabled', true);
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.log('Error: ' + error);
                }
            });
        });

        // Event delegation to handle dynamically added save buttons
        $(document).on('click', '.delete-img-btn', function () {
            if (confirm("Would you like to delete this image ?")) {
                var id = $(this).data('id');

                // Send the new value via AJAX
                $.ajax({
                    url: 'ajax.php?action=delete_post_image',
                    type: 'POST',
                    data: { ids: id },
                    success: function (response) {
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        console.log('Error: ' + error);
                    }
                });
            }
        });
    </script>
</body>

</html>
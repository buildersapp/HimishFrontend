<html>
    <?php include('includes/head.php'); ?>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
    <!-- Simple Datatables -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.3/dist/style.css">
    <style>
    .datatable-wrapper .datatable-top {
        margin-bottom: 0 !important;
    }
    </style>
    <body class="bg-gray-50 font-sans">

        <div id="main-container" class="flex h-screen">
    
            <?php include('includes/sidebar.php'); ?>

            <main id="main-content" class="flex-1 overflow-auto">

                <?php include('includes/nav-header.php'); ?>

                <!-- Main Content -->
                <div id="dashboard-content" class="p-8">
                    <!-- KPI Cards -->
                    <section id="kpi-cards" class="grid grid-cols-4 gap-6 mb-8">

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Ads Created</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1"><?= displayWithFallback($dashboardData['user']['total_ads_created']) ?></p>
                                    <?php 
                                        $growth = $dashboardData['user']['ads_created_growth'] ?? 0;
                                        $isNegative = $growth < 0;
                                    ?>
                                    <p class="text-sm mt-2 flex items-center <?= $isNegative ? 'text-red-600' : 'text-green-600' ?>">
                                        <i class="fa-solid <?= $isNegative ? 'fa-arrow-down' : 'fa-arrow-up' ?> mr-1"></i>
                                        <?= displayWithFallback($growth) ?>% from last month
                                    </p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fa-solid fa-ad text-green-600"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Pending Conversions</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1"><?= displayWithFallback($dashboardData['user']['total_pending_referral']) ?></p>
                                    <p class="text-orange-600 text-sm mt-2 flex items-center">
                                        <i class="fa-solid fa-clock mr-1"></i>
                                        Awaiting payment
                                    </p>
                                </div>
                                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                    <i class="fa-solid fa-hourglass-half text-orange-600"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Communities Created</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1"><?= displayWithFallback($dashboardData['user']['total_active_community']) ?></p>
                                    <p class="text-blue-600 text-sm mt-2 flex items-center">
                                        <i class="fa-solid fa-users mr-1"></i>
                                        <?= displayWithFallback($dashboardData['user']['total_community_member']) ?> total members
                                    </p>
                                </div>
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fa-solid fa-users text-purple-600"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">Total Earnings</p>
                                    <p class="text-3xl font-bold text-gray-900 mt-1">$<?= displayWithFallback($dashboardData['user']['total_earning']) ?></p>
                                    <?php 
                                        $earningGrowth = $dashboardData['user']['last_month_earning_percentage'] ?? 0;
                                        $isNegativeEarning = $earningGrowth < 0;
                                    ?>
                                    <p class="text-sm mt-2 flex items-center <?= $isNegativeEarning ? 'text-red-600' : 'text-green-600' ?>">
                                        <i class="fa-solid <?= $isNegativeEarning ? 'fa-arrow-down' : 'fa-arrow-up' ?> mr-1"></i>
                                        <?= displayWithFallback($earningGrowth) ?>% from last month
                                    </p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fa-solid fa-dollar-sign text-green-600"></i>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Action Buttons -->
                    <section id="action-buttons" class="flex space-x-4 mb-8">
                        <a href="create-post.php">
                            <button class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 flex items-center space-x-2">
                                <i class="fa-solid fa-file-text"></i>
                                <span>Create Post + Link</span>
                            </button>
                        </a>
                        <a href="create-community.php">
                            <button class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-purple-700 flex items-center space-x-2">
                                <i class="fa-solid fa-users"></i>
                                <span>Create Community + Invite</span>
                            </button>
                        </a>
                    </section>

                    <!-- Recent Activity Table -->
                    <?php if (!empty($dashboardData['recentActivityPost']) && is_array($dashboardData['recentActivityPost'])): ?>
                    <section id="recent-activity" class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                            <p class="text-gray-600 text-sm">Track your latest posts and community invites</p>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full" id="myTable">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Link/Community Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Commission</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <?php if (!empty($dashboardData['recentActivityPost']) && is_array($dashboardData['recentActivityPost'])): ?>
                                        <?php foreach ($dashboardData['recentActivityPost'] as $activity): ?>
                                            <?php
                                                $refLink = $activity['referral_link'] ?? [];
                                                $community = $refLink['community'] ?? [];
                                                $post = $refLink['post'] ?? [];
                                                $name = ($refLink['type'] == 0) ? $post['title'] : $community['name'];
                                                $type = ($refLink['type'] ?? 1) == 0 ? 'Post Invite' : 'Community Invite';
                                                $created = !empty($activity['created_at']) ? date("M d, Y", strtotime($activity['created_at'])) : '-';
                                                $commission = !empty($activity['commission']) ? "$" . number_format($activity['commission'], 2) : "-";

                                                // Status display
                                                $statusClass = "bg-gray-100 text-gray-800";
                                                $statusIcon = "fa-envelope";
                                                $statusText = "Not Opened";

                                                if ($activity['is_convert'] == '1') {
                                                    $statusClass = "bg-green-100 text-green-800";
                                                    $statusIcon = "fa-check";
                                                    $statusText = "Converted";
                                                } elseif ($activity['is_convert'] == '0') {
                                                    $statusClass = "bg-blue-100 text-blue-800";
                                                    $statusIcon = "fa-eye";
                                                    $statusText = "Opened";
                                                }
                                            ?>
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <?php if($refLink['type'] == 0 && !empty($post)): ?>
                                                        
                                                    <?php elseif($refLink['type'] == 1 && !empty($community)): ?>
                                                        
                                                    <?php else: ?>
                                                        <span class="text-red-500">Deleted</span>
                                                    <?php endif; ?>
                                                    <div class="font-medium text-gray-900"><?= htmlspecialchars($name) ?></div>
                                                    <div class="text-sm text-gray-500"><?= $type ?></div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                                        <?= $type === 'Post Invite' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800' ?>">
                                                        <?= $type ?>
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><?= $created ?></td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?= $statusClass ?>">
                                                        <i class="fa-solid <?= $statusIcon ?> mr-1"></i>
                                                        <?= $statusText ?>
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm <?= $commission !== '-' ? 'font-medium text-green-600' : 'text-gray-500' ?>">
                                                    <?= $commission ?>
                                                </td>
                                            </tr>
                                        <?php endforeach; ?>
                                    <?php else: ?>
                                        <tr>
                                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">No recent activity found</td>
                                        </tr>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                        </div>
                    </section>
                    <?php else: ?>
                        <section id="no-commissions-empty" class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 mb-8">
                            <div class="text-center max-w-md mx-auto">
                                <div class="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <i class="fa-solid fa-shoe-prints text-pink-600 text-2xl"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-900 mb-3">No recent activity</h3>
                                <p class="text-gray-600 mb-6">Start by creating communities and posts, then share your links to invite users. Track all your link activity here.</p>
                            </div>
                        </section>
                    <?php endif; ?>
                </div>
            </main>
        </div>
    </body>
    <?php include('includes/footer-scripts.php'); ?>
    <!-- Flowbite JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js?v=<?= time() ?>"></script>
  <!-- Simple Datatables -->
  <script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.3"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const dataTable = new simpleDatatables.DataTable("#myTable", {
        searchable: false,
        fixedHeight: false,
        perPageSelect: false,
        sortable: false,
      });
    });
  </script>
</html>